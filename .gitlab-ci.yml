stages:
  - build
  - image-test
  - deploy
  - app-test

variables:
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"

# ==============================
# BUILD IMAGE (KANIKO)
# ==============================
build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  variables:
    DOCKER_CONFIG: "/kaniko/.docker"
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context "${CI_PROJECT_DIR}/app" --dockerfile "${CI_PROJECT_DIR}/scripts/Dockerfile" --destination "${CI_REGISTRY_IMAGE}:${IMAGE_TAG}"

# ==============================
# STATIC TESTS
# ==============================
static-test:
  stage: image-test
  image: python:3.8-alpine
  before_script:
    - apk add --no-cache gcc musl-dev linux-headers
    - pip install pylint pytest pytest-cov flake8 mypy
  script:
    - echo "Running static code analysis..."
    - flake8 app --count --select=E9,F63,F7,F82 --show-source --statistics || true
    - pylint app/addrservice || true
    - mypy app/addrservice || true
    - pytest app/tests/unit --cov=app/addrservice || true
  allow_failure: true

# ==============================
# SECURITY SCAN (TRIVY)
# ==============================
security-scan:
  stage: image-test
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  script:
    - echo "Scanning image for vulnerabilities..."
    - trivy registry login --username "$CI_REGISTRY_USER" --password "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - trivy image --severity HIGH,CRITICAL ${CI_REGISTRY_IMAGE}:${IMAGE_TAG} || true
  allow_failure: true

# ==============================
# DEPLOY TO DOCKER SWARM
# ==============================
deploy:
  stage: deploy
  image: docker:24.0
  variables:
    DOCKER_HOST: "tcp://10.129.4.191:2375" # Swarm manager non TLS
  before_script:
    - apk add --no-cache curl
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - echo "Deploying Docker service to Swarm manager..."
    # Supprime l'ancien service si présent
    - docker service rm addressbook || true
    - sleep 5
    # Déploiement simple du service avec 2 réplicas
    - docker service create \
        --name addressbook \
        --replicas 2 \
        -p 8080:8080 \
        ${CI_REGISTRY_IMAGE}:${IMAGE_TAG}
    - docker service ls
  environment:
    name: production
    url: http://10.129.4.191:8080

# ==============================
# DYNAMIC TESTS (integration)
# ==============================
dynamic-test:
  stage: app-test
  image: python:3.8
  variables:
    APP_URL: "http://10.129.4.191:8080"
  before_script:
    - apt-get update && apt-get install -y curl
    - pip install requests pytest
  script:
    - echo "Waiting for application to be ready..."
    - until curl -s $APP_URL > /dev/null; do sleep 5; done
    - echo "Application is up, running integration tests..."
    - pytest app/tests/integration || true
  allow_failure: true
