stages:
  - build
  - image-test
  - deploy
  - app-test

variables:
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  CI_REGISTRY: "10.242.217.30:5050"
  CI_REGISTRY_USER: "root"
  CI_REGISTRY_IMAGE: "$CI_REGISTRY/root/sae"

# ==============================
# BUILD IMAGE (KANIKO)
# ==============================
build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  variables:
    DOCKER_CONFIG: "/kaniko/.docker"
  script:
    - mkdir -p /kaniko/.docker
    # Auth Docker pour Kaniko
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    # Construire et pousser l'image
    - /kaniko/executor --context "${CI_PROJECT_DIR}/app" --dockerfile "${CI_PROJECT_DIR}/scripts/Dockerfile" --destination "${CI_REGISTRY_IMAGE}:${IMAGE_TAG}" --insecure

# ==============================
# STATIC TESTS
# ==============================
static-test:
  stage: image-test
  image: python:3.8-alpine
  before_script:
    - apk add --no-cache gcc musl-dev linux-headers
    - pip install pylint pytest pytest-cov flake8 mypy
  script:
    - echo "Running static code analysis..."
    - flake8 app --count --select=E9,F63,F7,F82 --show-source --statistics || true
    - pylint app/addrservice || true
    - mypy app/addrservice || true
    - pytest app/tests/unit --cov=app/addrservice || true
  allow_failure: true

# ==============================
# SECURITY SCAN (TRIVY)
# ==============================
security-scan:
  stage: image-test
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  script:
    - echo "Scanning image for vulnerabilities..."
    - trivy registry login --username "$CI_REGISTRY_USER" --password "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY" --insecure
    - trivy image --severity HIGH,CRITICAL --insecure ${CI_REGISTRY_IMAGE}:${IMAGE_TAG} || true
  allow_failure: true

# ==============================
# DEPLOY TO DOCKER SWARM
# ==============================
deploy:
  stage: deploy
  image: docker:27.0
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache curl
    - mkdir -p /root/.docker
    - |
      AUTH=$(echo -n "$CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD" | base64)
      echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$AUTH\"}}}" > /root/.docker/config.json
  script:
    - docker rm -f addressbook || true
    - docker run -d --name addressbook -p 10000:8080 "$CI_REGISTRY_IMAGE:$IMAGE_TAG"
    - docker ps
  environment:
    name: production
    url: http://10.242.217.30:10000

# ==============================
# DYNAMIC TESTS (integration)
# ==============================
dynamic-test:
  stage: app-test
  image: python:3.8
  variables:
    APP_URL: "http://10.242.217.30:10000"
  before_script:
    - apt-get update && apt-get install -y curl
    - pip install requests pytest
  script:
    - echo "Waiting for application to be ready..."
    - until curl -s $APP_URL > /dev/null; do sleep 5; done
    - echo "Application is up, running integration tests..."
    - pytest app/tests/integration || true
  allow_failure: true