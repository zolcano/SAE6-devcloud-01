---
# 1) Pré-requis Docker sur les nœuds Swarm (hors GitLab)
- name: Install Docker on Swarm nodes
  hosts: swarm_manager:swarm_workers
  become: true
  tasks:
    - name: Install required packages
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: true

    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Add Docker GPG key
      ansible.builtin.shell: |
        curl -fsSL https://download.docker.com/linux/debian/gpg \
          | gpg --dearmor -o /etc/apt/keyrings/docker.gpg

    - name: Add Docker APT repository
      copy:
        dest: /etc/apt/sources.list.d/docker.list
        content: |
          deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian trixie stable
      notify: apt update

    - name: Install Docker engine + compose plugin
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: true

    - name: Ensure Docker service is running
      service:
        name: docker
        state: started
        enabled: true

  handlers:
    - name: apt update
      apt:
        update_cache: true

# 2) GitLab + registry installés en dur sur la VM "code"
- name: Deploy GitLab (code management node)
  hosts: gitlab
  become: true
  vars:
    gitlab_external_url: "http://{{ ansible_host }}"
  tasks:
    - name: Install required packages for GitLab repository
      apt:
        name:
          - ca-certificates
          - curl
          - openssh-server
          - tzdata
          - perl
        state: present
        update_cache: true

    - name: Download GitLab Omnibus installer script
      get_url:
        url: https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh
        dest: /tmp/gitlab_install.sh
        mode: "0755"

    - name: Run GitLab Omnibus installer script
      command: bash /tmp/gitlab_install.sh

    - name: Install GitLab CE package
      apt:
        name: gitlab-ce
        state: present
        update_cache: true

    - name: Configure GitLab CE (external URL + registry)
      copy:
        dest: /etc/gitlab/gitlab.rb
        mode: "0600"
        content: |
          external_url "{{ gitlab_external_url }}"
          gitlab_rails['gitlab_shell_ssh_port'] = 2222
          registry_external_url "http://{{ ansible_host }}:5050"
          registry['enable'] = true
          registry['registry_http_addr'] = "0.0.0.0:5050"

    - name: Reconfigure GitLab
      command: gitlab-ctl reconfigure

# 3) Init Docker Swarm sur le manager
- name: Init Docker Swarm manager
  hosts: swarm_manager
  become: true
  vars:
    swarm_advertise_addr: "{{ ansible_host }}"
  tasks:
    - name: Initialize Docker Swarm
      command: >
        docker swarm init --advertise-addr {{ swarm_advertise_addr }}
      register: swarm_init
      failed_when: swarm_init.rc not in [0, 1]
      changed_when: swarm_init.rc == 0

    - name: Get worker join token
      command: docker swarm join-token -q worker
      register: worker_token

    - name: Set fact with worker token
      set_fact:
        swarm_worker_join_token: "{{ worker_token.stdout }}"

# 4) Installation de gitlab-runner sur le manager Swarm
- name: Install GitLab Runner manually on Swarm manager
  hosts: swarm_manager
  become: true

  tasks:
    - name: Install dependencies
      apt:
        name:
          - curl
        state: present
        update_cache: true

    - name: Download GitLab Runner binary
      get_url:
        url: "https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64"
        dest: /usr/local/bin/gitlab-runner
        mode: '0755'

    - name: Create gitlab-runner user
      user:
        name: gitlab-runner
        comment: GitLab Runner
        shell: /bin/bash
        create_home: yes

    - name: Install GitLab Runner as a service
      command: gitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner
      args:
        creates: /etc/systemd/system/gitlab-runner.service

    - name: Start GitLab Runner service
      systemd:
        name: gitlab-runner
        enabled: true
        state: started

# 5) Join des workers au Swarm
- name: Join Swarm workers
  hosts: swarm_workers
  become: true
  vars:
    manager_ip: "{{ hostvars[groups['swarm_manager'][0]].ansible_host }}"
    worker_token: "{{ hostvars[groups['swarm_manager'][0]].swarm_worker_join_token }}"
  tasks:
    - name: Join worker to Swarm
      command: >
        docker swarm join
        --token {{ worker_token }}
        {{ manager_ip }}:2377
      register: join_result
      failed_when: join_result.rc not in [0, 1]
      changed_when: join_result.rc == 0

# 6) Déploiement de l'application sur le Swarm
- name: Deploy application stack on Swarm
  hosts: swarm_manager
  become: true
  vars:
    stack_name: "sae6-app"
    compose_file: "/root/sae6-stack.yml"
  tasks:
    - name: Copy application stack file
      copy:
        dest: "{{ compose_file }}"
        mode: "0644"
        content: |
          version: "3.9"
          services:
            app:
              image: "registry.gitlab.example.com/namespace/projet:latest"
              deploy:
                replicas: 3
              ports:
                - "8080:8080"
    - name: Deploy stack
      command: >
        docker stack deploy -c {{ compose_file }} {{ stack_name }}
